{% extends "base.html" %}
{% block title %}Sales Invoice | Panda Medicine{% endblock %}
{% block content %}

<div class="page-header">
    <h3 class="page-title">Sales Invoice</h3>
</div>

<div class="row">
    <div class="col-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div id="formAlert" class="alert d-none" role="alert"></div>
                    <button type="button" id="editBtn" class="btn btn-sm btn-outline-primary d-none ms-auto">
                        <i class="mdi mdi-pencil"></i> Edit Invoice
                    </button>
                </div>

                <form id="salesForm">
                    <div class="row">
                        <div class="col-md-4 form-group">
                            <label>Customer Name</label>
                            <input type="text" class="form-control" id="customer_name" required>
                        </div>
                        <div class="col-md-4 form-group">
                            <label>Doctor Name</label>
                            <input type="text" class="form-control" id="doctor_name">
                        </div>
                        <div class="col-md-4 form-group">
                            <label>Payment Mode</label>
                            <select class="form-select" id="payment_mode">
                                <option value="Cash">Cash</option>
                                <option value="Online">Online</option>
                                <option value="Credit">Credit</option>
                            </select>
                        </div>
                    </div>

                    <hr>
                    <h5>Sales Items</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered" id="salesTable">
                            <thead class="bg-light">
                                <tr>
                                    <th style="width: 35%;">Medicine (Name - Rack)</th>
                                    <th>MRP</th>
                                    <th>Qty</th>
                                    <th>Discount (%)</th>
                                    <th>Selling Price</th>
                                    <th style="width:50px;"></th>
                                </tr>
                            </thead>
                            <tbody id="itemsBody"></tbody>
                            <tfoot>
                                <tr class="font-weight-bold bg-light">
                                    <td class="text-end">Totals:</td>
                                    <td id="footer_total_mrp">0.00</td>
                                    <td id="footer_total_qty">0</td>
                                    <td id="footer_total_discount">0.00</td>
                                    <td id="footer_total_selling" class="text-primary">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="addItemBtn">
                            <i class="mdi mdi-plus"></i> Add Medicine
                        </button>
                    </div>

                    <hr>
                    <button type="submit" class="btn btn-gradient-primary" id="submitBtn">
                        <i class="mdi mdi-content-save"></i> Save Invoice
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const API_URL = "/apis/salesInvoices";
    const form = document.getElementById("salesForm");
    const itemsBody = document.getElementById("itemsBody");
    const addItemBtn = document.getElementById("addItemBtn");
    const submitBtn = document.getElementById("submitBtn");
    const editBtn = document.getElementById("editBtn");
    const alertBox = document.getElementById("formAlert");

    let MEDICINES = [];
    let invoiceId = new URLSearchParams(window.location.search).get("id");
    let isEditMode = false;

    function showMessage(msg, type="success") {
        alertBox.className = `alert alert-${type}`;
        alertBox.innerHTML = msg;
        alertBox.classList.remove("d-none");
        window.scrollTo(0, 0);
    }

    function setDisabled(disabled) {
        // Disable inputs and selects, but not buttons (except addItemBtn)
        const inputs = form.querySelectorAll("input, select");
        inputs.forEach(el => el.disabled = disabled);
        addItemBtn.disabled = disabled;
        itemsBody.querySelectorAll(".removeBtn").forEach(btn => btn.disabled = disabled);
    }

    function calculateRow(row) {
        const mrp = parseFloat(row.querySelector(".mrp").value) || 0;
        const qty = parseInt(row.querySelector(".quantity").value) || 0;
        let discPercent = parseFloat(row.querySelector(".discount").value) || 0;

        if (discPercent > 20) {
            discPercent = 20;
            row.querySelector(".discount").value = 20;
        }

        const totalMRP = mrp * qty;
        const discountAmt = totalMRP * (discPercent / 100);
        const sellingPrice = totalMRP - discountAmt;

        row.querySelector(".selling_price").value = sellingPrice.toFixed(2);
        calculateGrandTotal();
    }

    function calculateGrandTotal() {
        let gMRP = 0, gQty = 0, gSelling = 0;
        itemsBody.querySelectorAll("tr").forEach(row => {
            const mrp = parseFloat(row.querySelector(".mrp").value) || 0;
            const qty = parseInt(row.querySelector(".quantity").value) || 0;
            const sell = parseFloat(row.querySelector(".selling_price").value) || 0;
            gMRP += (mrp * qty);
            gQty += qty;
            gSelling += sell;
        });
        document.getElementById("footer_total_mrp").textContent = gMRP.toFixed(2);
        document.getElementById("footer_total_qty").textContent = gQty;
        document.getElementById("footer_total_discount").textContent = (gMRP - gSelling).toFixed(2);
        document.getElementById("footer_total_selling").textContent = gSelling.toFixed(2);
    }

    function addItemRow(data = {}) {
        let options = `<option value="">Select Medicine</option>`;
        MEDICINES.forEach(m => {
            const selected = data.medicine_id == m.id ? "selected" : "";
            options += `<option value="${m.id}" data-mrp="${m.mrp}" ${selected}>${m.name} - ${m.rack_location || 'N/A'}</option>`;
        });

        const rowHtml = `
            <tr>
                <td><select class="form-control medicine_id" required>${options}</select></td>
                <td><input type="number" step="0.01" class="form-control mrp" value="${data.mrp || ""}" readonly></td>
                <td><input type="number" class="form-control quantity" value="${data.quantity || ""}" min="1" required></td>
                <td><input type="number" step="0.01" class="form-control discount" value="${data.discount || 0}" min="0" max="20"></td>
                <td><input type="number" step="0.01" class="form-control selling_price" value="${data.selling_price || ""}" readonly></td>
                <td class="text-center"><button type="button" class="btn btn-sm btn-danger removeBtn">Ã—</button></td>
            </tr>
        `;
        itemsBody.insertAdjacentHTML("beforeend", rowHtml);
        if(data.medicine_id) calculateRow(itemsBody.lastElementChild);
    }

    itemsBody.addEventListener("change", e => {
        if (e.target.classList.contains("medicine_id")) {
            const row = e.target.closest("tr");
            const selectedOption = e.target.options[e.target.selectedIndex];
            row.querySelector(".mrp").value = selectedOption.dataset.mrp || 0;
            calculateRow(row);
        }
    });

    itemsBody.addEventListener("input", e => {
        if (e.target.classList.contains("quantity") || e.target.classList.contains("discount")) {
            calculateRow(e.target.closest("tr"));
        }
    });

    itemsBody.addEventListener("click", e => {
        if (e.target.classList.contains("removeBtn")) {
            e.target.closest("tr").remove();
            calculateGrandTotal();
        }
    });

    addItemBtn.onclick = () => addItemRow();

    function loadInitialData() {
        fetch("/apis/getMedicines")
            .then(r => r.json())
            .then(res => {
                if (!res.status) return;
                MEDICINES = res.data;

                if (invoiceId) {
                    fetch(`${API_URL}?id=${invoiceId}`)
                        .then(r => r.json())
                        .then(res => {
                            if (!res.status) return showMessage(res.message, "danger");
                            const inv = res.data.invoice;
                            document.getElementById("customer_name").value = inv.customer_name;
                            document.getElementById("doctor_name").value = inv.doctor_name;
                            document.getElementById("payment_mode").value = inv.payment_mode;

                            itemsBody.innerHTML = "";
                            res.data.items.forEach(item => addItemRow(item));
                            calculateGrandTotal();
                            setDisabled(true);
                            submitBtn.classList.add("d-none");
                            editBtn.classList.remove("d-none");
                        });
                } else {
                    addItemRow();
                }
            });
    }

    editBtn.onclick = () => {
        isEditMode = true;
        setDisabled(false);
        submitBtn.classList.remove("d-none");
        editBtn.classList.add("d-none");
    };

    form.onsubmit = e => {
        e.preventDefault();
        
        // Use parseFloat/parseInt to ensure we aren't sending weird concatenated strings
        const items = [...itemsBody.querySelectorAll("tr")].map(row => ({
            medicine_id: parseInt(row.querySelector(".medicine_id").value),
            quantity: parseInt(row.querySelector(".quantity").value),
            mrp: parseFloat(row.querySelector(".mrp").value),
            discount: parseFloat(row.querySelector(".discount").value),
            selling_price: parseFloat(row.querySelector(".selling_price").value)
        }));

        if (items.some(item => !item.medicine_id)) {
            return showMessage("Please select a medicine for all rows.", "danger");
        }

        const payload = {
            customer_name: document.getElementById("customer_name").value,
            doctor_name: document.getElementById("doctor_name").value,
            payment_mode: document.getElementById("payment_mode").value,
            items: items
        };

        let method = "POST";
        if (invoiceId && isEditMode) {
            payload.id = invoiceId;
            method = "PATCH";
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = "Processing...";

        fetch(API_URL, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(res => {
            if (res.status) {
                showMessage("Invoice saved successfully!");
                setTimeout(() => {
                    window.location.href = window.location.pathname + "?id=" + (res.id || invoiceId);
                    location.reload();
                }, 1000);
            } else {
                showMessage(JSON.stringify(res.message), "danger");
                submitBtn.disabled = false;
                submitBtn.innerHTML = "Save Invoice";
            }
        })
        .catch(err => {
            showMessage("Server Error", "danger");
            submitBtn.disabled = false;
        });
    };

    loadInitialData();
});
</script>
{% endblock %}