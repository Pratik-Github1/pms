{% extends "base.html" %}
{% block title %}Create Sales Invoice | Panda Medicine{% endblock %}
{% block content %}

<style>
    #itemsBody select,
    #itemsBody input {
        font-size: 13px;
    }
</style>

<div class="page-header">
    <h3 class="page-title">Create Sales Invoice</h3>
</div>

<div class="row">
    <div class="col-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div id="formAlert" class="alert d-none" role="alert"></div>

                    <button type="button"
                            id="editBtn"
                            class="btn btn-sm btn-outline-primary d-none ms-auto">
                        <i class="mdi mdi-pencil"></i> Edit
                    </button>
                </div>

                <form id="salesForm">

                    <!-- Invoice Header -->
                    <div class="row">
                        <div class="col-md-4">
                            <label>Customer Name</label>
                            <input type="text" class="form-control" id="customer_name">
                        </div>

                        <div class="col-md-4">
                            <label>Doctor Name</label>
                            <input type="text" class="form-control" id="doctor_name">
                        </div>

                        <div class="col-md-4">
                            <label>Invoice Date</label>
                            <input type="date" class="form-control" id="invoice_date" required>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label>Payment Mode</label>
                            <select class="form-control" id="payment_mode">
                                <option value="Cash">Cash</option>
                                <option value="Online">Online</option>
                                <option value="Credit">Credit</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label>Invoice Discount (%)</label>
                            <input type="number" class="form-control" id="discount" value="0">
                        </div>

                        <div class="col-md-4">
                            <label>Remarks</label>
                            <input type="text" class="form-control" id="remarks">
                        </div>
                    </div>

                    <hr>

                    <!-- Items -->
                    <h5>Sales Items</h5>

                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Medicine</th>
                                <th>Qty</th>
                                <th>Selling Price</th>
                                <th>MRP</th>
                                <th style="width:50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody"></tbody>
                    </table>

                    <button type="button" class="btn btn-sm btn-outline-secondary" id="addItemBtn">
                        + Add Item
                    </button>

                    <hr>

                    <button type="submit" class="btn btn-gradient-primary" id="submitBtn">
                        Submit
                    </button>

                </form>

            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const API_URL = "/apis/salesInvoices";

    const form = document.getElementById("salesForm");
    const alertBox = document.getElementById("formAlert");
    const editBtn = document.getElementById("editBtn");
    const submitBtn = document.getElementById("submitBtn");
    const itemsBody = document.getElementById("itemsBody");
    const addItemBtn = document.getElementById("addItemBtn");

    let invoiceId = new URLSearchParams(window.location.search).get("id");
    let isEditMode = false;

    let MEDICINES = [];

    function showMessage(msg, type="success") {
        alertBox.className = `alert alert-${type}`;
        alertBox.textContent = msg;
        alertBox.classList.remove("d-none");
    }

    function hideMessage() {
        alertBox.classList.add("d-none");
    }

    function setDisabled(disabled) {
        [...form.elements].forEach(el => {
            if (el.tagName !== "BUTTON") el.disabled = disabled;
        });
    }

    function addItemRow(data = {}) {
        let options = `<option value="">Select Medicine</option>`;
        MEDICINES.forEach(m => {
            const selected = data.medicine_id == m.id ? "selected" : "";
            options += `<option value="${m.id}" ${selected}>${m.name}</option>`;
        });

        itemsBody.insertAdjacentHTML("beforeend", `
            <tr>
                <td>
                    <select class="form-control medicine_id">${options}</select>
                </td>
                <td>
                    <input type="number" class="form-control quantity" value="${data.quantity || ""}">
                </td>
                <td>
                    <input type="number" step="0.01" class="form-control selling_price"
                           value="${data.selling_price || ""}">
                </td>
                <td>
                    <input type="number" step="0.01" class="form-control mrp"
                           value="${data.mrp || ""}">
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-danger removeBtn">Ã—</button>
                </td>
            </tr>
        `);
    }

    const items = collectItems();
        items.forEach(item => {
            fetch("/apis/salesInvoiceItems", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    sales_invoice_id: invoiceId,
                    medicine_id: item.medicine_id,
                    quantity: item.quantity,
                    selling_price: item.selling_price,
                    mrp: item.mrp
                })
            });
        });

    function loadMedicines(callback=null) {
        fetch("/apis/getMedicines")
            .then(r => r.json())
            .then(res => {
                if (!res.status) return;
                MEDICINES = res.data;
                if (callback) callback();
            });
    }

    function collectItems() {
        return [...itemsBody.querySelectorAll("tr")].map(row => ({
            medicine_id: row.querySelector(".medicine_id").value,
            quantity: row.querySelector(".quantity").value,
            selling_price: row.querySelector(".selling_price").value,
            mrp: row.querySelector(".mrp").value
        }));
    }

    addItemBtn.onclick = () => addItemRow();

    itemsBody.addEventListener("click", e => {
        if (e.target.classList.contains("removeBtn")) {
            e.target.closest("tr").remove();
        }
    });

    loadMedicines(() => addItemRow());

    if (invoiceId) {
        fetch(`${API_URL}?id=${invoiceId}`)
            .then(r => r.json())
            .then(res => {
                if (!res.status) return showMessage(res.message, "danger");

                const inv = res.data;

                customer_name.value = inv.customer_name;
                doctor_name.value = inv.doctor_name;
                invoice_date.value = inv.invoice_date;
                payment_mode.value = inv.payment_mode;
                discount.value = inv.discount;
                remarks.value = inv.remarks;

                loadMedicines(() => {
                    itemsBody.innerHTML = "";
                    res.data.items.forEach(addItemRow);
                });

                setDisabled(true);
                submitBtn.classList.add("d-none");
                editBtn.classList.remove("d-none");
            });
    }

    editBtn.onclick = () => {
        isEditMode = true;
        setDisabled(false);
        submitBtn.classList.remove("d-none");
        editBtn.classList.add("d-none");
    };

    form.onsubmit = e => {
        e.preventDefault();
        hideMessage();

        const payload = {
            customer_name: customer_name.value,
            doctor_name: doctor_name.value,
            invoice_date: invoice_date.value,
            payment_mode: payment_mode.value,
            discount: discount.value,
            remarks: remarks.value,
            items: collectItems()
        };

        let method = "POST";
        if (invoiceId && isEditMode) {
            payload.id = invoiceId;
            method = "PATCH";
        }

        fetch(API_URL, {
            method,
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(res => {
            if (!res.status) return showMessage(res.message, "danger");
            showMessage(res.message);
        });
    };

});
</script>

{% endblock %}
