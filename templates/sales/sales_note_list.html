{% extends "base.html" %}
{% block title %}Sales List | Panda Medicine{% endblock %}
{% block content %}

<div class="page-header d-flex justify-content-between align-items-center">
    <h3 class="page-title mb-0">Sales Invoices</h3>

    <button class="btn btn-gradient-primary btn-sm"
            onclick="window.location.href='/createSalesNote/'">
        <i class="mdi mdi-plus"></i> Create Sales Invoice
    </button>
</div>

<div class="row mt-3">
    <div class="col-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">

                <!-- Search -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text"
                               id="searchInput"
                               class="form-control"
                               placeholder="Search customer...">
                    </div>
                </div>

                <!-- Table -->
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Customer</th>
                                <th>Invoice Details</th>
                                <th>Amount</th>
                                <th>Total Items</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div id="paginationInfo" class="text-muted"></div>
                    <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const tableBody = document.getElementById("salesTableBody");
    const pagination = document.getElementById("pagination");
    const paginationInfo = document.getElementById("paginationInfo");
    const searchInput = document.getElementById("searchInput");

    let currentPage = 1;
    let pageSize = 10;
    let currentSearch = "";

    function fetchSales(page = 1) {

        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">Loading...</td>
            </tr>
        `;

        fetch(`/apis/salesInvoicesList?page=${page}&page_size=${pageSize}&search=${currentSearch}`)
            .then(res => res.json())
            .then(res => {

                const data = res.results.data;
                const total = res.count;

                tableBody.innerHTML = "";

                if (!data.length) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                No sales invoices found
                            </td>
                        </tr>`;
                    return;
                }

                data.forEach((item, index) => {
                    tableBody.innerHTML += `
                        <tr>
                            <td>${(page - 1) * pageSize + index + 1}</td>
                            <td>${item.customer_name}</td>
                            <td>
                                <div>${item.invoice_number}</div>
                                <small>${item.invoice_date}</small>
                            </td>
                            <td>
                                <div>${item.total_amount}</div>
                                <small>${item.payment_mode}</small>
                            </td>
                            <td>${item.total_items}</td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-primary"
                                        onclick="window.location.href='/createSalesInvoice/?id=${item.id}'">
                                    <i class="mdi mdi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                renderPagination(total, page);
                renderInfo(page, total);
            });
    }

    function renderPagination(total, page) {
        pagination.innerHTML = "";
        const totalPages = Math.ceil(total / pageSize);

        for (let i = 1; i <= totalPages; i++) {
            pagination.innerHTML += `
                <li class="page-item ${i === page ? "active" : ""}">
                    <a class="page-link" href="#">${i}</a>
                </li>
            `;
        }

        pagination.querySelectorAll(".page-link").forEach(link => {
            link.onclick = e => {
                e.preventDefault();
                currentPage = Number(link.textContent);
                fetchSales(currentPage);
            };
        });
    }

    function renderInfo(page, total) {
        const start = (page - 1) * pageSize + 1;
        const end = Math.min(page * pageSize, total);
        paginationInfo.innerText = `Showing ${start}â€“${end} of ${total} invoices`;
    }

    searchInput.addEventListener("keyup", function () {
        currentSearch = this.value;
        currentPage = 1;
        fetchSales();
    });

    fetchSales();
});
</script>

{% endblock %}
