{% extends "base.html" %}
{% block title %}Store Profile | Panda Medicine{% endblock %}
{% block content %}
<div class="page-header">
    <h3 class="page-title">
        Your Store Profile Details
    </h3>
</div>
<div class="row">
    <div class="col-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div id="formAlert" class="alert d-none" role="alert"></div>

                    <button type="button"
                            id="editBtn"
                            class="btn btn-sm btn-outline-primary d-none"
                            title="Edit Store Profile">
                        <i class="mdi mdi-pencil"></i> Edit
                    </button>
                </div>

                <form class="forms-sample" id="storeProfileForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Store Name</label>
                                <input type="text" class="form-control" id="store_name" placeholder="Store Name">
                            </div>
                        </div>
                    
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Owner Name</label>
                                <input type="text" class="form-control" id="owner_name" placeholder="Owner Name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>GST Number</label>
                                <input type="text" class="form-control" id="gst_number" placeholder="GST Number">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Drug License Number</label>
                                <input type="text" class="form-control" id="drug_license_number" placeholder="Drug License Number">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                           <div class="form-group">
                                <label>City</label>
                                <input type="text" class="form-control" id="city" placeholder="City">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>State</label>
                                <input type="text" class="form-control" id="state" placeholder="State">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                           <div class="form-group">
                                <label>Pincode</label>
                                <input type="number" class="form-control" id="pincode" placeholder="Pincode">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Country</label>
                                <input type="text" class="form-control" id="country" placeholder="Country">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Address</label>
                                <textarea class="form-control" id="address_line" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Invoice Footer Note</label>
                                <textarea class="form-control" id="invoice_footer_note" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Store Logo</label>
                                <input type="file"
                                    class="form-control"
                                    id="logo"
                                    accept="image/*">
                            </div>
                        </div>

                        <div class="col-md-6 d-flex align-items-center">
                            <div class="form-group mb-0">
                                <img id="logoPreview"
                                    src=""
                                    alt="Store Logo"
                                    style="max-height: 80px; display: none; border-radius: 6px; border: 1px solid #ddd;">
                            </div>
                        </div>
                    </div>

                    <button type="reset" class="btn btn-gradient-danger me-2" id="cancelBtn">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-gradient-primary me-2" id="submitBtn">
                        Submit
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    
    document.addEventListener("DOMContentLoaded", function () {

        const form = document.getElementById("storeProfileForm");
        const submitBtn = document.getElementById("submitBtn");
        const editBtn = document.getElementById("editBtn");
        const alertBox = document.getElementById("formAlert");

        let storeId = null;
        let isEditMode = false;

        const fields = [
            "store_name",
            "owner_name",
            "gst_number",
            "drug_license_number",
            "city",
            "state",
            "pincode",
            "country",
            "address_line",
            "invoice_footer_note"
        ];
        const logoInput = document.getElementById("logo");
        const logoPreview = document.getElementById("logoPreview");

        /* -------------------- UI Helpers -------------------- */

        function showMessage(type, message) {
            alertBox.className = `alert alert-${type}`;
            alertBox.textContent = message;
            alertBox.classList.remove("d-none");
        }

        function hideMessage() {
            alertBox.classList.add("d-none");
            alertBox.textContent = "";
        }

        /* -------------------- Validation Layer -------------------- */

        function validateForm() {
            const storeName = document.getElementById("store_name").value.trim();
            const ownerName = document.getElementById("owner_name").value.trim();
            const gst = document.getElementById("gst_number").value.trim();
            const drugLicense = document.getElementById("drug_license_number").value.trim();
            const city = document.getElementById("city").value.trim();
            const state = document.getElementById("state").value.trim();
            const pincode = document.getElementById("pincode").value.trim();
            const country = document.getElementById("country").value.trim();
            const address = document.getElementById("address_line").value.trim();
            const invoiceNote = document.getElementById("invoice_footer_note").value.trim();

            const nameRegex = /^[A-Z][a-zA-Z\s]{4,}$/;
            const alphaRegex = /^[A-Z][a-zA-Z\s]+$/;
            const gstRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
            const drugRegex = /^[A-Za-z0-9\-\/]{5,}$/;
            const pincodeRegex = /^[0-9]{6}$/;

            if (!nameRegex.test(storeName)) {
                showMessage("danger", "Store Name must be at least 5 characters and start with a capital letter.");
                return false;
            }

            if (!nameRegex.test(ownerName)) {
                showMessage("danger", "Owner Name must be at least 5 characters and start with a capital letter.");
                return false;
            }

            if (gst && !gstRegex.test(gst)) {
                showMessage("danger", "Please enter a valid GST Number.");
                return false;
            }

            if (drugLicense && !drugRegex.test(drugLicense)) {
                showMessage("danger", "Drug License Number is invalid.");
                return false;
            }

            if (!alphaRegex.test(city)) {
                showMessage("danger", "City must contain only letters and start with a capital letter.");
                return false;
            }

            if (!alphaRegex.test(state)) {
                showMessage("danger", "State must contain only letters and start with a capital letter.");
                return false;
            }

            if (!pincodeRegex.test(pincode)) {
                showMessage("danger", "Pincode must be a 6-digit number.");
                return false;
            }

            if (!alphaRegex.test(country)) {
                showMessage("danger", "Country must contain only letters and start with a capital letter.");
                return false;
            }

            if (address.length < 10) {
                showMessage("danger", "Address must be at least 10 characters long.");
                return false;
            }

            if (invoiceNote.length < 5) {
                showMessage("danger", "Invoice footer note must be at least 5 characters long.");
                return false;
            }

            return true;
        }

        function setFormDisabled(disabled) {
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = disabled;
            });

            if (logoInput) {
                logoInput.disabled = disabled;
            }
        }


        /* -------------------- Populate Data -------------------- */

        function populateForm(data) {
            fields.forEach(id => {
                if (data[id] !== undefined && document.getElementById(id)) {
                    document.getElementById(id).value = data[id] || "";
                }
            });

            if (data.logo) {
                logoPreview.src = data.logo;
                logoPreview.style.display = "block";
            }
        }

        /* -------------------- Live logo preview on selection (Edit / Create) -------------------- */
        logoInput.addEventListener("change", function () {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    logoPreview.src = e.target.result;
                    logoPreview.style.display = "block";
                };
                reader.readAsDataURL(this.files[0]);
            }
        });


        /* -------------------- Fetch Store Profile -------------------- */

        fetch("/apis/getStoreInformation")
            .then(res => res.json())
            .then(response => {

                if (response.status && response.data) {
                    storeId = response.data.id;
                    populateForm(response.data);

                    setFormDisabled(true);
                    editBtn.classList.remove("d-none");

                    submitBtn.textContent = "Update";
                }
            })
            .catch(() => {
                showMessage("danger", "Unable to load store information.");
            });

        /* -------------------- Edit Button -------------------- */

        editBtn.addEventListener("click", function () {
            isEditMode = true;
            setFormDisabled(false);
            submitBtn.textContent = "Update";
            hideMessage();
        });

        /* -------------------- Submit / Update -------------------- */

        form.addEventListener("submit", function (e) {
            e.preventDefault();
            hideMessage();
            if (!validateForm()) return;
            const formData = new FormData();

            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el && el.value !== "") {
                    formData.append(id, el.value);
                }
            });

            let url = "/apis/storeInformation";
            let method = "POST";

            if (storeId) {
                url += `?id=${storeId}`;
                method = "PATCH";
                formData.append("id", storeId);
            }
            if (logoInput.files && logoInput.files[0]) {
                formData.append("logo", logoInput.files[0]);
            }
            fetch(url, {
                method: method,
                body: formData
            })
            .then(res => res.json())
            .then(response => {

                if (response.status) {
                    showMessage("success", response.message);

                    setFormDisabled(true);
                    editBtn.classList.remove("d-none");
                    isEditMode = false;
                } else {
                    showMessage("danger", response.message || "Something went wrong.");
                }
            })
            .catch(() => {
                showMessage("danger", "Server error. Please try again.");
            });
        });

    });
</script>

{% endblock %}

